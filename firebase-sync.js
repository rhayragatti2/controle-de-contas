// ============================================
// FIREBASE SYNC - Sistema de Sincroniza√ß√£o
// ============================================

// Configura√ß√£o do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAUE8OUVtat1eYnu7o_UK5sKDz06CntJmU",
    authDomain: "controle-financeiro-2f875.firebaseapp.com",
    databaseURL: "https://controle-financeiro-2f875-default-rtdb.firebaseio.com",
    projectId: "controle-financeiro-2f875",
    storageBucket: "controle-financeiro-2f875.firebasestorage.app",
    messagingSenderId: "700647503137",
    appId: "1:700647503137:web:410281fe93431dec3c3a60"
  };

// Inicializar Firebase
let firebaseApp;
let auth;
let database;
let currentUser = null;
let isFirebaseEnabled = false;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    database = firebase.database();
    isFirebaseEnabled = true;
    console.log('Firebase inicializado com sucesso');
} catch (error) {
    console.warn('Firebase n√£o configurado ou erro na inicializa√ß√£o:', error.message);
    isFirebaseEnabled = false;
}

// Nota: Autentica√ß√£o agora √© gerenciada pelo auth-simple.js
// Firebase √© usado apenas para sincroniza√ß√£o de dados

// ===== SINCRONIZA√á√ÉO DE DADOS =====

let listenersAtivos = {};
let ignorarProximaAtualizacaoFirebase = false;

// Constantes para prefixos de armazenamento
const PREFIX_FIREBASE = 'contas-firebase-';
const CHAVE_CATEGORIAS_FIREBASE = 'contas-firebase-categorias';

/**
 * Sincroniza√ß√£o inicial quando a p√°gina carrega
 */
async function sincronizarDadosInicial() {
    if (!isFirebaseEnabled) return;

    try {
        console.log('üîÑ Carregando dados do Firebase...');
        
        // BUSCAR DADOS DO FIREBASE
        const snapshot = await database.ref('dados-compartilhados').once('value');
        const dadosFirebase = snapshot.val();

        if (dadosFirebase) {
            // CARREGAR DADOS DO FIREBASE
            carregarDadosDoFirebase(dadosFirebase);
            console.log('‚úÖ Dados do Firebase carregados!');
        } else {
            // Se n√£o h√° dados no Firebase, inicializar vazio
            inicializarDadosVazios();
            console.log('‚úÖ Dados inicializados (Firebase vazio)');
        }
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o inicial:', error);
        // Se houver erro, inicializar dados vazios para n√£o travar
        inicializarDadosVazios();
    }
}

/**
 * Carrega dados do Firebase na interface
 */
function carregarDadosDoFirebase(dadosFirebase) {
    console.log('‚òÅÔ∏è Carregando dados do Firebase...');
    
    // Carregar categorias
    if (dadosFirebase.categorias && Array.isArray(dadosFirebase.categorias)) {
        categorias = dadosFirebase.categorias;
        localStorage.setItem(CHAVE_CATEGORIAS_FIREBASE, JSON.stringify(categorias));
    } else {
        // Categorias padr√£o se n√£o houver
        categorias = [
            { nome: 'Sal√°rio', cor: PALETA_CORES[0] },
            { nome: 'Moradia', cor: PALETA_CORES[1] },
            { nome: 'Alimenta√ß√£o', cor: PALETA_CORES[2] },
            { nome: 'Transporte', cor: PALETA_CORES[3] },
            { nome: 'Lazer', cor: PALETA_CORES[4] }
        ];
        localStorage.setItem(CHAVE_CATEGORIAS_FIREBASE, JSON.stringify(categorias));
    }
    
    renderizarCategorias();
    
    // Carregar poupan√ßa (GLOBAL - acumulativa)
    if (dadosFirebase.poupanca && Array.isArray(dadosFirebase.poupanca)) {
        poupanca = dadosFirebase.poupanca;
        localStorage.setItem('contas-firebase-poupanca', JSON.stringify(poupanca));
        if (typeof renderizarPoupanca === 'function') {
            renderizarPoupanca();
        }
    }
    
    // Carregar dados do m√™s atual
    if (dadosFirebase.meses && dadosFirebase.meses[mesAtual]) {
        const dadosMes = dadosFirebase.meses[mesAtual];
        entradas = dadosMes.entradas || [];
        despesas = dadosMes.despesas || [];
        
        // Carregar gastos avulsos do m√™s
        if (dadosMes.gastosAvulsos && Array.isArray(dadosMes.gastosAvulsos)) {
            // Atualizar array global mantendo gastos de outros meses
            gastosAvulsos = gastosAvulsos.filter(g => g.mes !== mesAtual);
            gastosAvulsos.push(...dadosMes.gastosAvulsos);
        }
    } else {
        entradas = [];
        despesas = [];
        // Remover gastos avulsos deste m√™s se n√£o h√° dados
        gastosAvulsos = gastosAvulsos.filter(g => g.mes !== mesAtual);
    }
    
    // Salvar no localStorage com prefixo Firebase
    const chaveMesFirebase = `${PREFIX_FIREBASE}${mesAtual}`;
    const gastosAvulsosMes = gastosAvulsos.filter(g => g.mes === mesAtual);
    localStorage.setItem(chaveMesFirebase, JSON.stringify({ 
        entradas, 
        despesas,
        gastosAvulsos: gastosAvulsosMes
    }));
    
    renderizarTudo();
    console.log('‚úÖ Dados do Firebase carregados na interface');
}

/**
 * Inicializa dados vazios quando n√£o h√° dados no Firebase
 */
function inicializarDadosVazios() {
    // Categorias padr√£o
    categorias = [
        { nome: 'Sal√°rio', cor: PALETA_CORES[0] },
        { nome: 'Moradia', cor: PALETA_CORES[1] },
        { nome: 'Alimenta√ß√£o', cor: PALETA_CORES[2] },
        { nome: 'Transporte', cor: PALETA_CORES[3] },
        { nome: 'Lazer', cor: PALETA_CORES[4] }
    ];
    localStorage.setItem(CHAVE_CATEGORIAS_FIREBASE, JSON.stringify(categorias));
    renderizarCategorias();
    
    // Dados vazios
    entradas = [];
    despesas = [];
    gastosAvulsos = [];
    const chaveMesFirebase = `${PREFIX_FIREBASE}${mesAtual}`;
    localStorage.setItem(chaveMesFirebase, JSON.stringify({ 
        entradas, 
        despesas,
        gastosAvulsos: []
    }));
    
    renderizarTudo();
}


/**
 * Sincroniza um m√™s espec√≠fico para o Firebase (√°rea compartilhada)
 */
async function sincronizarMesParaFirebase(mes, dados) {
    if (!isFirebaseEnabled) return;

    try {
        // Ativar flag para ignorar a pr√≥xima atualiza√ß√£o do listener
        ignorarProximaAtualizacaoFirebase = true;
        console.log('üîí Bloqueando listener temporariamente...');
        
        await database.ref(`dados-compartilhados/meses/${mes}`).set(dados);
        console.log(`‚úÖ M√™s ${mes} sincronizado com Firebase`);
        
        // Desativar o flag ap√≥s 2 segundos (tempo suficiente para o Firebase processar)
        setTimeout(() => {
            ignorarProximaAtualizacaoFirebase = false;
            console.log('üîì Listener desbloqueado');
        }, 2000);
    } catch (error) {
        console.error('‚ùå Erro ao sincronizar m√™s:', error);
        ignorarProximaAtualizacaoFirebase = false; // Desbloquear em caso de erro
    }
}

/**
 * Sincroniza categorias para o Firebase (√°rea compartilhada)
 */
async function sincronizarCategoriasParaFirebase(cats) {
    if (!isFirebaseEnabled) return;

    try {
        await database.ref('dados-compartilhados/categorias').set(cats);
        console.log('Categorias sincronizadas');
    } catch (error) {
        console.error('Erro ao sincronizar categorias:', error);
    }
}

/**
 * Sincroniza poupan√ßa para o Firebase (√°rea compartilhada - GLOBAL)
 */
async function sincronizarPoupancaParaFirebase(poupancaData) {
    if (!isFirebaseEnabled) return;

    try {
        await database.ref('dados-compartilhados/poupanca').set(poupancaData);
        console.log('Poupan√ßa sincronizada');
    } catch (error) {
        console.error('Erro ao sincronizar poupan√ßa:', error);
    }
}

// ===== LISTENERS EM TEMPO REAL =====

/**
 * Inicia listeners para mudan√ßas em tempo real (√°rea compartilhada)
 */
function iniciarListenersSincronizacao() {
    if (!isFirebaseEnabled) return;

    // Listener para categorias compartilhadas
    const refCategorias = database.ref('dados-compartilhados/categorias');
    listenersAtivos.categorias = refCategorias.on('value', (snapshot) => {
        const categoriasFirebase = snapshot.val();
        if (categoriasFirebase && Array.isArray(categoriasFirebase)) {
            if (JSON.stringify(categoriasFirebase) !== JSON.stringify(categorias)) {
                categorias = categoriasFirebase;
                localStorage.setItem(CHAVE_CATEGORIAS_FIREBASE, JSON.stringify(categorias));
                renderizarCategorias();
                console.log('‚òÅÔ∏è Categorias compartilhadas atualizadas');
            }
        }
    });
    
    // Listener para poupan√ßa compartilhada (GLOBAL - acumulativa)
    const refPoupanca = database.ref('dados-compartilhados/poupanca');
    listenersAtivos.poupanca = refPoupanca.on('value', (snapshot) => {
        const poupancaFirebase = snapshot.val();
        if (poupancaFirebase && Array.isArray(poupancaFirebase)) {
            if (JSON.stringify(poupancaFirebase) !== JSON.stringify(poupanca)) {
                poupanca = poupancaFirebase;
                localStorage.setItem('contas-firebase-poupanca', JSON.stringify(poupanca));
                if (typeof renderizarPoupanca === 'function') {
                    renderizarPoupanca();
                }
                console.log('‚òÅÔ∏è Poupan√ßa compartilhada atualizada');
            }
        }
    });

    // Listener para mudan√ßas no m√™s atual compartilhado
    const refMesAtual = database.ref(`dados-compartilhados/meses/${mesAtual}`);
    listenersAtivos.mesAtual = refMesAtual.on('value', (snapshot) => {
        // Se estamos ignorando atualiza√ß√µes (acabamos de salvar localmente), pular
        if (ignorarProximaAtualizacaoFirebase) {
            console.log('‚è≠Ô∏è Ignorando atualiza√ß√£o do Firebase (salvamento local recente)');
            return;
        }
        
        const dadosMesFirebase = snapshot.val();
        if (dadosMesFirebase) {
            const chaveMesFirebase = `${PREFIX_FIREBASE}${mesAtual}`;
            const dadosLocaisStr = localStorage.getItem(chaveMesFirebase);
            const dadosFirebaseStr = JSON.stringify(dadosMesFirebase);
            
            if (dadosLocaisStr !== dadosFirebaseStr) {
                console.log('‚òÅÔ∏è Recebendo atualiza√ß√£o do Firebase...');
                entradas = dadosMesFirebase.entradas || [];
                despesas = dadosMesFirebase.despesas || [];
                
                // Atualizar gastos avulsos do m√™s
                if (dadosMesFirebase.gastosAvulsos && Array.isArray(dadosMesFirebase.gastosAvulsos)) {
                    gastosAvulsos = gastosAvulsos.filter(g => g.mes !== mesAtual);
                    gastosAvulsos.push(...dadosMesFirebase.gastosAvulsos);
                } else {
                    gastosAvulsos = gastosAvulsos.filter(g => g.mes !== mesAtual);
                }
                
                localStorage.setItem(chaveMesFirebase, dadosFirebaseStr);
                renderizarTudo();
                console.log('‚òÅÔ∏è Dados compartilhados do m√™s atual atualizados');
            }
        } else {
            // Se n√£o h√° dados no Firebase para este m√™s, mostrar vazio
            entradas = [];
            despesas = [];
            gastosAvulsos = gastosAvulsos.filter(g => g.mes !== mesAtual);
            const chaveMesFirebase = `${PREFIX_FIREBASE}${mesAtual}`;
            localStorage.setItem(chaveMesFirebase, JSON.stringify({ 
                entradas: [], 
                despesas: [],
                gastosAvulsos: []
            }));
            renderizarTudo();
        }
    });
}

/**
 * Para todos os listeners ativos
 */
function pararListenersSincronizacao() {
    if (!isFirebaseEnabled) return;

    if (listenersAtivos.categorias) {
        database.ref('dados-compartilhados/categorias').off('value', listenersAtivos.categorias);
    }
    if (listenersAtivos.poupanca) {
        database.ref('dados-compartilhados/poupanca').off('value', listenersAtivos.poupanca);
    }
    if (listenersAtivos.mesAtual) {
        database.ref(`dados-compartilhados/meses/${mesAtual}`).off('value', listenersAtivos.mesAtual);
    }

    listenersAtivos = {};
    console.log('Listeners de sincroniza√ß√£o parados');
}

/**
 * Atualiza o listener do m√™s quando o m√™s muda (√°rea compartilhada)
 */
function atualizarListenerMes(novoMes) {
    if (!isFirebaseEnabled) return;
    
    // Parar listener anterior
    if (listenersAtivos.mesAtual) {
        database.ref(`dados-compartilhados/meses/${mesAtual}`).off('value', listenersAtivos.mesAtual);
    }

    // Iniciar novo listener
    const refNovoMes = database.ref(`dados-compartilhados/meses/${novoMes}`);
    listenersAtivos.mesAtual = refNovoMes.on('value', (snapshot) => {
        // Se estamos ignorando atualiza√ß√µes (acabamos de salvar localmente), pular
        if (ignorarProximaAtualizacaoFirebase) {
            console.log('‚è≠Ô∏è Ignorando atualiza√ß√£o do Firebase (salvamento local recente)');
            return;
        }
        
        const dadosMesFirebase = snapshot.val();
        const chaveMesFirebase = `${PREFIX_FIREBASE}${novoMes}`;
        
        if (dadosMesFirebase) {
            const dadosLocaisStr = localStorage.getItem(chaveMesFirebase);
            const dadosFirebaseStr = JSON.stringify(dadosMesFirebase);
            
            if (dadosLocaisStr !== dadosFirebaseStr) {
                console.log(`‚òÅÔ∏è Recebendo atualiza√ß√£o do Firebase para ${novoMes}...`);
                entradas = dadosMesFirebase.entradas || [];
                despesas = dadosMesFirebase.despesas || [];
                
                // Atualizar gastos avulsos do novo m√™s
                if (dadosMesFirebase.gastosAvulsos && Array.isArray(dadosMesFirebase.gastosAvulsos)) {
                    gastosAvulsos = gastosAvulsos.filter(g => g.mes !== novoMes);
                    gastosAvulsos.push(...dadosMesFirebase.gastosAvulsos);
                } else {
                    gastosAvulsos = gastosAvulsos.filter(g => g.mes !== novoMes);
                }
                
                localStorage.setItem(chaveMesFirebase, dadosFirebaseStr);
                renderizarTudo();
                console.log(`‚òÅÔ∏è Dados compartilhados de ${novoMes} atualizados`);
            }
        } else {
            // Se n√£o h√° dados no Firebase para este m√™s, mostrar vazio
            entradas = [];
            despesas = [];
            gastosAvulsos = gastosAvulsos.filter(g => g.mes !== novoMes);
            localStorage.setItem(chaveMesFirebase, JSON.stringify({ 
                entradas: [], 
                despesas: [],
                gastosAvulsos: []
            }));
            renderizarTudo();
        }
    });
}

// ===== INICIALIZA√á√ÉO AUTOM√ÅTICA =====
// Iniciar sincroniza√ß√£o quando a p√°gina carregar
if (isFirebaseEnabled) {
    // Esperar um pouco para garantir que o auth-simple.js carregou
    setTimeout(() => {
        if (window.authSimple && window.authSimple.verificarSessao()) {
            sincronizarDadosInicial();
            iniciarListenersSincronizacao();
        }
    }, 100);
}

// ===== EXPORTAR FUN√á√ïES =====
window.firebaseSync = {
    sincronizarMesParaFirebase,
    sincronizarCategoriasParaFirebase,
    sincronizarPoupancaParaFirebase,
    atualizarListenerMes,
    isEnabled: () => isFirebaseEnabled,
    iniciarSincronizacao: () => {
        sincronizarDadosInicial();
        iniciarListenersSincronizacao();
    }
};

